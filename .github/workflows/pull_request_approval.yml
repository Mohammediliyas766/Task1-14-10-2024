name: Pull Request Approval

on:
  pull_request:
    types: [opened, edited, reopened]

jobs:
  request-approval:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Send email notification
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        run: |
          curl -X POST "https://api.sendgrid.com/v3/mail/send" \
          -H "Authorization: Bearer $SENDGRID_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "personalizations": [
              {
                "to": [
                  {
                    "email": "approver@example.com"
                  }
                ],
                "subject": "Approval Request for Pull Request"
              }
            ],
            "from": {
              "email": "noreply@example.com"
            },
            "content": [
              {
                "type": "text/plain",
                "value": "A new pull request has been created. Please review it."
              }
            ]
          }'

  approve-pr:
    runs-on: ubuntu-latest
    needs: request-approval
    if: github.event.pull_request.merged == true

    steps:
      - name: Merge Pull Request
        uses: peter-evans/merge-pull-request@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash # Choose merge method: merge, squash, or rebase
